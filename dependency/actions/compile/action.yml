# This composite action works when called from a workflow that has qemu and buildkit set up.
# Docker daemon and cli experimental features must also be enabled.
# Compilation is slow when run on emulated platforms, so the .github/workflows/compile-dependency.yml
# reusable workflow is used instead of this composite action. This is left here for reference.
name: 'Compile ICU on Target'
description: |
  Compiles ICU

inputs:
  version:
    description: 'dependency version'
    required: true
  outputDir:
    description: 'output directory'
    required: true
  target:
    description: 'dependency OS target variant'
    required: true
  os:
    description: 'platform OS (e.g., linux)'
    required: true
  arch:
    description: 'platform architecture (e.g., amd64)'
    required: true

runs:
  using: 'composite'
  steps:

  - name: docker build
    shell: bash
    run: |
      docker build \
        --tag compilation \
        --file dependency/actions/compile/${{ inputs.target }}.Dockerfile \
        --platform ${{ inputs.os }}/${{ inputs.arch }} \
        dependency/actions/compile

  - name: docker run
    shell: bash
    run: |
      docker run \
        --platform ${{ inputs.os }}/${{ inputs.arch }} \
        --volume ${{ inputs.outputDir }}:/home \
        compilation \
        --version ${{ inputs.version }} \
        --outputDir /home \
        --target ${{ inputs.target }}

  - name: print contents of output dir
    shell: bash
    run: ls -lah ${{ inputs.outputDir }}
